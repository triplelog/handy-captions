
const https = require('https');
var fs = require("fs");
const zlib = require('zlib');
const { createGzip } = require('zlib');
const { pipeline } = require('stream');
const {
  createReadStream,
  createWriteStream
} = require('fs');
var qs = require('querystring');
const { exec } = require('child_process');
const bodyParser = require('body-parser');
var nunjucks = require('nunjucks');
var crypto = require("crypto");
const options = {
  key: fs.readFileSync('/etc/letsencrypt/live/digitizer.fun/privkey.pem'),
  cert: fs.readFileSync('/etc/letsencrypt/live/digitizer.fun/fullchain.pem')
};
const { PerformanceObserver, performance } = require('perf_hooks');

/*const mongoose = require('mongoose');
mongoose.connect('mongodb://45.32.213.227:27017/triplelog', {useNewUrlParser: true});
const User = require('./models/user');
const UserData = require('./models/userdata');*/

var express = require('express');



var app = express();



app.use('/',express.static('static'));
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true })); 

app.get('/', 
	
	function(req, res) {
		res.write(nunjucks.render('templates/index.html',{
		
		}));
		res.end();
	}
);
app.get('/index.html', 
	
	function(req, res) {
		res.write(nunjucks.render('templates/index.html',{
		
		}));
		res.end();
	}
);
app.get('/magic.html', 
	
	function(req, res) {
		res.write(nunjucks.render('templates/magic.html',{
		
		}));
		res.end();
	}
);
app.get('/magicmaker', 
	
	function(req, res) {
		res.write(nunjucks.render('templates/magicemoji.html',{
		
		}));
		res.end();
	}
);

function pathToPoints(path) {
	path = path.replace(/,/g," ");
	path = path.replace(/M /g,"M");
	path = path.replace(/ M/g,"M");
	path = path.replace(/M/g," M ");
	path = path.replace(/Z /g,"Z");
	path = path.replace(/ Z/g,"Z");
	path = path.replace(/Z/g," Z ");
	path = path.trim();
	var pSplit = path.split(" ").slice(1);
	if (pSplit[pSplit.length-1] == "Z" || pSplit[pSplit.length-1] == "z"){
		pSplit.splice(pSplit.length-1,1);
		pSplit.push(pSplit[0]);
		pSplit.push(pSplit[1]);
	}
	else if (pSplit[pSplit.length-2] != pSplit[0] || pSplit[pSplit.length-1] != pSplit[1]){
		pSplit.push(pSplit[0]);
		pSplit.push(pSplit[1]);
	}
	
	var points = [];
	var box = {top:0,bottom:0,left:0,right:0};
	var d = 0;
	var lp = [];
	for (var i=0;i<pSplit.length/2;i++){
		var point = [parseFloat(pSplit[2*i]),parseFloat(pSplit[2*i+1])];
		if (i==0){
			box.top=point[1];
			box.bottom=point[1];
			box.left=point[0];
			box.right=point[0];
		}
		else {
			d += Math.pow(Math.pow(point[0]-lp[0],2)+Math.pow(point[1]-lp[1],2),0.5);
			if (point[1]<box.bottom) {
				box.bottom=point[1];
			}
			if (point[1]>box.top) {
				box.top=point[1];
			}
			if (point[0]<box.left) {
				box.left=point[0];
			}
			if (point[0]>box.right) {
				box.right=point[0];
			}
		}
		points.push(point);
		lp = point;
	}
	var width = (box.right-box.left)/(box.top-box.bottom)*100;
	
	for (var i=0;i<points.length;i++){
		points[i][0]=Math.round((points[i][0]-box.left)/(box.right-box.left)*width*10)/10;
		points[i][1]=Math.round((points[i][1]-box.bottom)/(box.top-box.bottom)*100*10)/10;
	}
	return [points,width,d];
}

var jsonShapes = {'full':"M 0,0 0,100 100,100 100,0"};
var shapes = fs.readFileSync('./shapes/stateborders.csv', 'utf8').split("\r");
//console.log(shapes[0]);
for (var i=1;i<shapes.length;i++){
	var sp = shapes[i].split(",");
	if (sp.length < 4){continue;}

	var paths = [];
	var path = "";
	for (var ii=0;ii<sp[3].length;ii++){
		if (sp[3][ii]=="M"){
			if (path.length > 0){
				paths.push(path);
			}
			path = "M";
		}
		else {
			path += sp[3][ii];
		}
	}
	if (path.length > 0){
		paths.push(path);
	}
	var path = "";
	for (var ii=0;ii<paths.length;ii++){
		if (paths[ii].length > path.length){
			path = paths[ii];
		}
	}
	jsonShapes[sp[1]]=path;
}

shapes = fs.readFileSync('./shapes/europeborders.csv', 'utf8').split("\r");
//console.log(shapes[0]);
for (var i=1;i<shapes.length;i++){
	var sp = shapes[i].split(",");
	if (sp.length < 6){continue;}

	var paths = [];
	
	for (var iii=5;iii<sp.length;iii++){
		var path = "";
		for (var ii=0;ii<sp[iii].length;ii++){
			if (sp[iii][ii]=="M"){
				if (path.length > 0){
					paths.push(path);
				}
				path = "M";
			}
			else {
				path += sp[iii][ii];
			}
		}
		if (path.length > 0){
			paths.push(path);
		}
	}
	
	var path = "";
	var maxD = 0;
	for (var ii=0;ii<paths.length;ii++){
		var d = pathToPoints(paths[ii])[2];
		if (d > maxD){
			path = paths[ii];
			maxD = d;
		}
	}
	jsonShapes[sp[1]]=path;
}
var def = "eJxVkttxBTEIQ1txBYzN0xSRBtJ/IZHwTWbytT4Gg9DytbRDolYd6QK4HF2l4glQ0ctIKQCfZmQ/0MOIHYDxrrbEnDVXtrQOnJVXfOriJkv6A3dlyvVJcmTNFesyzaVqwHn2GCmGgIm9ABSlSvD9/gDUEQKVj5wYgK7ccu9A9ooW1wGLFVfOq6YrSu6n8lmR4jY9H2SO5iyCfSD45rwBjOe2Z1+z8NiXMk2c7Uv2JXRPAL5BmOnYv4uS7wTQGLO4zxNtjnzee0yRyGWXlp2EtGV7i46zaEOIoOUQblv5L3OSCbAeP2nHAJ4CcGX70Ef+WJsI/l/ZS9v0HtDTEzVxnl24nJ8Be9Je5E2AXXJRm8nU/7J8wFmellFMsAtthimI5PP88HzfktlkTQBik3B0siC2puTbMsi/9btmhPt/sb9/AHrPjQw=";
app.get('/game', 
	function(req, res) {
		//var path = "M 188.05 123.86 187.66 123.67 187.54 123.5 187.54 123.27 187.47 123.02 187.24 122.59 187.08 122.47 186.97 122.18 186.86 121.68 186.69 121.36 186.46 121.22 186.3 121.06 186.22 120.87 186.14 120.75 186.05 120.69 186.01 120.59 186.0 120.45 185.87 120.27 185.48 119.93 185.38 119.73 185.2 119.51 184.74 119.08 184.74 119.08 184.3 118.24 184.3 118.24 184.25 118.07 184.15 118.0 184.0 117.98 183.85 117.89 183.63 117.68 183.63 117.68 183.27 117.42 183.34 117.19 183.62 116.88 183.72 116.72 183.73 116.71 183.77 116.71 184.07 116.61 184.38 116.51 184.45 116.52 184.62 116.41 184.98 116.29 185.12 116.21 185.19 116.23 185.5 116.25 185.8 116.26 186.11 116.27 186.41 116.29 186.72 116.3 187.02 116.32 187.33 116.33 187.63 116.34 187.69 116.37 187.71 116.4 187.7 116.5 187.71 116.56 187.93 116.44 188.03 116.58 188.2 116.81 188.21 116.94 188.22 117.13 188.49 117.14 188.76 117.15 189.03 117.16 189.3 117.17 189.58 117.18 189.85 117.19 190.12 117.2 190.39 117.21 190.65 117.48 190.91 117.76 191.17 118.03 191.43 118.31 191.69 118.58 191.95 118.85 192.21 119.13 192.49 119.42 192.46 119.43 191.95 119.79 191.8 119.94 191.38 120.55 191.28 120.94 191.19 120.78 191.21 120.65 191.21 120.55 191.11 120.77 191.21 121.08 191.12 121.2 190.84 121.43 190.69 121.46 190.52 121.53 190.47 121.75 190.23 121.95 190.1 122.04 189.85 121.99 189.93 122.18 189.84 122.33 189.68 122.44 189.49 122.52 189.38 122.51 189.28 122.55 189.21 122.64 189.03 122.73 188.84 122.68 188.62 122.65 188.5 122.7 188.7 122.79 188.81 122.92 188.79 123.09 188.74 123.15 188.61 123.24 188.55 123.23 188.52 123.15 188.48 122.98 188.42 123.02 188.41 123.09 188.36 123.12 188.18 122.86 188.19 123.06 188.25 123.22 188.31 123.3 188.37 123.34 188.39 123.41 188.27 123.59 188.2 123.63 188.09 123.66 188.03 123.77 188.05 123.86 Z";
		var shape = "full";
		var speed = ["__*__-_X+","15_?_30_l_15"];
		var balls = ["__+","3_l"];
		var lives = ["__+_N","x_1_7"];
		var win = ["__-_X","75_l_50"];
		//1000*(pointData.c-pointData.v/2)/(pointData.r0+1)/Math.log(pointData.d+3)/Math.log(pointData.t+3)
		var pointFormula = ["___/-_*__+/__+L/__+L/","c_v_2_1000_r0_1_d_3_t_3"];
		console.log(req.query);
		var path = jsonShapes[shape];
		if (req.query){
			if (req.query.n){
				shape = req.query.n;
				path = jsonShapes[shape];
			}
			else if (req.query.p){
				var p = req.query.p.replace(/ /g,"+");
				path = zlib.inflateSync(new Buffer.from(p, 'base64')).toString();
			
			}
			
			if (req.query.l){
				lives = decodeURIComponent(req.query.l).split("~");
				console.log(lives);
			}
			if (req.query.x){
				//req.query.x;
			}
			if (req.query.b){
				balls = decodeURIComponent(req.query.b).split("~");
				console.log(balls);
			}
			if (req.query.w){
				win = decodeURIComponent(req.query.w).split("~");
				console.log(win);
			}
			if (req.query.s){
				speed = decodeURIComponent(req.query.s).split("~");
				console.log(speed);
			}
			if (req.query.f){
				pointFormula = decodeURIComponent(req.query.f).split("~");
				console.log(pointFormula);
			}
		}
		//var deflated = zlib.deflateSync(path).toString('base64');
		
		var retval = pathToPoints(path);
		res.write(nunjucks.render('templates/dtzfun.html',{
			//bigwall: {id:"wall-0",balls:[],v:[[0,0],[0,50],[0,100],[100,100],[190,20],[9,2],[0,0]]},
			bigwall: retval[0],
			width: retval[1],
			speed: speed,
			balls: balls,
			lives: lives,
			win: win,
			pointFormula: pointFormula,
		}));
		res.end();
	}
);

var golfHoles = [];
function addHoles() {
	golfHoles.push({path:"M-9787165.0,-5143361.0 -9771681.0,-5149222.0 -9758271.0,-5144510.0 -9756307.0,-5148473.0 -9751421.0,-5144844.0 -9753397.0,-5141361.0 -9749594.0,-5133319.0 -9754511.0,-5137879.0 -9753356.0,-5129749.0 -9760335.0,-5125806.0 -9763350.0,-5128465.0 -9755577.0,-5132418.0 -9755428.0,-5140021.0 -9763529.0,-5136622.0 -9761654.0,-5138288.0 -9762247.0,-5140228.0 -9773446.0,-5140795.0 -9780982.0,-5136771.0 -9787165.0,-5143361.0 ",ball: {x:40,y:35,d:5,a:1,s:20,el:null},hole: {x:99,y:34},cd: 1707});
	golfHoles.push({path:"M-13605261.0,-4527590.0 -13595338.0,-4534936.0 -13595163.0,-4541321.0 -13592537.0,-4539555.0 -13591755.0,-4541020.0 -13599659.0,-4552119.0 -13581513.0,-4547066.0 -13569917.0,-4549614.0 -13566901.0,-4542665.0 -13531663.0,-4553534.0 -13531625.0,-4515029.0 -13521891.0,-4507539.0 -13564921.0,-4506862.0 -13565937.0,-4511446.0 -13573424.0,-4519324.0 -13582909.0,-4514524.0 -13585264.0,-4517932.0 -13594029.0,-4509974.0 -13605261.0,-4527590.0 ",ball: {x:92,y:79,d:5,a:1,s:20,el:null},hole: {x:22,y:65},cd: 0615});
	golfHoles.push({path:"M-10221676.0,-3614329.0 -10206221.0,-3634955.0 -10203162.0,-3613418.0 -10187468.0,-3616550.0 -10196159.0,-3600214.0 -10164589.0,-3587890.0 -10135425.0,-3615734.0 -10081891.0,-3610018.0 -10072836.0,-3539205.0 -10036149.0,-3527946.0 -10056013.0,-3495078.0 -10085679.0,-3531537.0 -10124937.0,-3517450.0 -10132358.0,-3544887.0 -10156738.0,-3548823.0 -10139572.0,-3568548.0 -10152560.0,-3582575.0 -10165839.0,-3537543.0 -10150994.0,-3538672.0 -10160829.0,-3519807.0 -10140103.0,-3521701.0 -10145483.0,-3496675.0 -10070856.0,-3478313.0 -10079100.0,-3462135.0 -10099004.0,-3471803.0 -10110266.0,-3433239.0 -10153322.0,-3428532.0 -10140390.0,-3478051.0 -10214253.0,-3567691.0 -10221676.0,-3614329.0 ",ball: {x:16,y:33,d:5,a:1,s:20,el:null},hole: {x:32,y:60},cd: 2206});
	golfHoles.push({path:"M-13116619.0,-4033887.0 -13107874.0,-4043931.0 -13105421.0,-4039479.0 -13082715.0,-4039170.0 -13078748.0,-4047928.0 -13063668.0,-4043151.0 -13065599.0,-4031503.0 -13086531.0,-4033295.0 -13092391.0,-4018751.0 -13097336.0,-4018648.0 -13107240.0,-4031468.0 -13116619.0,-4033887.0 ",ball: {x:94,y:53,d:5,a:1,s:20,el:null},hole: {x:28,y:24},cd: 0635});
	golfHoles.push({path:"M-13109824.0,-3955233.0 -13100823.0,-3960138.0 -13094862.0,-3974656.0 -13088952.0,-3969531.0 -13085885.0,-3981031.0 -13081370.0,-3974184.0 -13075358.0,-3975510.0 -13081122.0,-3962530.0 -13053246.0,-3955790.0 -13053332.0,-3938103.0 -13045521.0,-3922133.0 -13049958.0,-3910390.0 -13048999.0,-3907911.0 -13047139.0,-3907723.0 -13047204.0,-3906267.0 -13046629.0,-3906002.0 -13037936.0,-3912123.0 -13035459.0,-3895081.0 -13041416.0,-3898517.0 -13043290.0,-3891353.0 -13052908.0,-3892930.0 -13049326.0,-3882160.0 -13053842.0,-3875274.0 -13061289.0,-3879820.0 -13072867.0,-3918889.0 -13109824.0,-3955233.0 ",ball: {x:42,y:69,d:5,a:1,s:20,el:null},hole: {x:24,y:42},cd: 0649});
	golfHoles.push({path:"M-13524023.0,-4640351.0 -13514388.0,-4641455.0 -13519315.0,-4649748.0 -13510038.0,-4652286.0 -13514345.0,-4665350.0 -13507718.0,-4671431.0 -13504037.0,-4682041.0 -13482863.0,-4681232.0 -13472711.0,-4651460.0 -13472673.0,-4621929.0 -13501080.0,-4614780.0 -13501140.0,-4620660.0 -13504524.0,-4620623.0 -13509563.0,-4632212.0 -13519770.0,-4632154.0 -13524023.0,-4640351.0 ",ball: {x:7,y:66,d:5,a:1,s:20,el:null},hole: {x:48,y:10},cd: 0607});
	golfHoles.push({path:"M-9421263.0,-3988495.0 -9402983.0,-4005650.0 -9385557.0,-4009757.0 -9385282.0,-4000364.0 -9377458.0,-3989857.0 -9382238.0,-3983245.0 -9377988.0,-3973920.0 -9380192.0,-3968393.0 -9400700.0,-3973768.0 -9406248.0,-3982785.0 -9421263.0,-3988495.0 ",ball: {x:13,y:49,d:5,a:1,s:20,el:null},hole: {x:54,y:82},cd: 1305});
	golfHoles.push({path:"M-12950296.0,-5413422.0 -12942381.0,-5433586.0 -12894060.0,-5404616.0 -12827404.0,-5480739.0 -12800715.0,-5457665.0 -12835699.0,-5555578.0 -12770939.0,-5604406.0 -12756471.0,-5668477.0 -12778785.0,-5701902.0 -12727163.0,-5694188.0 -12683475.0,-5731704.0 -12629761.0,-5600360.0 -12593736.0,-5585818.0 -12562880.0,-5521259.0 -12499684.0,-5553854.0 -12408561.0,-5549228.0 -12399302.0,-5583026.0 -12361915.0,-5539101.0 -12361664.0,-5161234.0 -12805989.0,-5160422.0 -12805938.0,-5276788.0 -12935519.0,-5319422.0 -12910684.0,-5329253.0 -12910265.0,-5367698.0 -12950296.0,-5413422.0 ",ball: {x:92,y:40,d:5,a:1,s:20,el:null},hole: {x:37,y:11},cd: 1602});
	golfHoles.push({path:"M-13881935.0,-5277085.0 -13836653.0,-5401590.0 -13824479.0,-5508389.0 -13778637.0,-5509427.0 -13772455.0,-5532755.0 -13758830.0,-5532713.0 -13759379.0,-5577729.0 -13704075.0,-5564891.0 -13708310.0,-5582079.0 -13692268.0,-5572369.0 -13668143.0,-5589219.0 -13558716.0,-5571820.0 -13555271.0,-5481176.0 -13578238.0,-5443325.0 -13577073.0,-5407907.0 -13597624.0,-5391565.0 -13578106.0,-5351889.0 -13589467.0,-5322289.0 -13717860.0,-5267928.0 -13717850.0,-5235513.0 -13743244.0,-5219590.0 -13717890.0,-5204642.0 -13718025.0,-5161570.0 -13841316.0,-5161467.0 -13867014.0,-5229319.0 -13856333.0,-5253513.0 -13881935.0,-5277085.0 ",ball: {x:33,y:95,d:5,a:1,s:20,el:null},hole: {x:55,y:34},cd: 4104});
	golfHoles.push({path:"M-10333769.0,-4583074.0 -10311546.0,-4640486.0 -10296517.0,-4640041.0 -10285349.0,-4684373.0 -10265957.0,-4670686.0 -10256033.0,-4730913.0 -10200650.0,-4730135.0 -10200160.0,-4742872.0 -10099108.0,-4753824.0 -10088146.0,-4705520.0 -10067728.0,-4717001.0 -10030933.0,-4699286.0 -10054400.0,-4706091.0 -10073540.0,-4686180.0 -10096302.0,-4693442.0 -10108246.0,-4683518.0 -10100721.0,-4645558.0 -10071540.0,-4647561.0 -10057004.0,-4633973.0 -10058320.0,-4610028.0 -10099062.0,-4632876.0 -10105604.0,-4608300.0 -10189667.0,-4609272.0 -10200476.0,-4586626.0 -10333769.0,-4583074.0 ",ball: {x:62,y:17,d:5,a:1,s:20,el:null},hole: {x:18,y:72},cd: 2903});
	golfHoles.push({path:"M-10342621.0,-4412584.0 -10341945.0,-4448959.0 -10317744.0,-4448457.0 -10317833.0,-4506442.0 -10244650.0,-4523429.0 -10243749.0,-4580929.0 -10200476.0,-4586626.0 -10189667.0,-4609272.0 -10105604.0,-4608300.0 -10099047.0,-4632878.0 -9964952.0,-4536114.0 -9950174.0,-4445582.0 -9918453.0,-4433285.0 -9931818.0,-4380040.0 -9948155.0,-4386982.0 -9959135.0,-4363791.0 -9970553.0,-4378652.0 -9966955.0,-4335458.0 -9985561.0,-4334524.0 -9973295.0,-4320197.0 -9986130.0,-4300756.0 -10060821.0,-4300027.0 -10025897.0,-4342329.0 -10035706.0,-4369357.0 -10327370.0,-4369317.0 -10326538.0,-4412114.0 -10342621.0,-4412584.0 ",ball: {x:97,y:95,d:5,a:1,s:20,el:null},hole: {x:86,y:56},cd: 2908});
	golfHoles.push({path:"M-10023272.0,-3670323.0 -10023261.0,-3684112.0 -9951871.0,-3689245.0 -9952099.0,-3736675.0 -9886192.0,-3741396.0 -9886190.0,-3752876.0 -9872722.0,-3747754.0 -9864846.0,-3752944.0 -9868960.0,-3756761.0 -9863351.0,-3770218.0 -9846587.0,-3770276.0 -9838910.0,-3523945.0 -9887552.0,-3531521.0 -9895082.0,-3521538.0 -9927881.0,-3530850.0 -9971644.0,-3527124.0 -9983511.0,-3561724.0 -9996927.0,-3574361.0 -10002301.0,-3588890.0 -9988492.0,-3633065.0 -10000488.0,-3633015.0 -10000484.0,-3642484.0 -10019415.0,-3649943.0 -10023272.0,-3670323.0 ",ball: {x:36,y:22,d:5,a:1,s:20,el:null},hole: {x:13,y:51},cd: 2804});
	golfHoles.push({path:"M-9091516.0,-5058435.0 -9089278.0,-5074576.0 -9067009.0,-5063978.0 -9071280.0,-5075124.0 -9065682.0,-5086499.0 -9073962.0,-5086575.0 -9072002.0,-5175431.0 -9044690.0,-5193453.0 -8963429.0,-5210109.0 -8963349.0,-5061658.0 -8974330.0,-5064144.0 -8974281.0,-5052598.0 -8984790.0,-5052534.0 -8983708.0,-5066674.0 -9017234.0,-5063787.0 -9017199.0,-5052521.0 -9038261.0,-5052819.0 -9038346.0,-5042201.0 -9060497.0,-5053234.0 -9063047.0,-5030641.0 -9071374.0,-5037728.0 -9074558.0,-5032416.0 -9076730.0,-5032506.0 -9071367.0,-5045795.0 -9091516.0,-5058435.0 ",ball: {x:12,y:87,d:5,a:1,s:20,el:null},hole: {x:48,y:31},cd: 3914});
	golfHoles.push({path:"M-17379121.0,-2241840.0 -17375928.0,-2251855.0 -17352962.0,-2275202.0 -17361280.0,-2299926.0 -17356481.0,-2308729.0 -17347671.0,-2311124.0 -17270143.0,-2271785.0 -17258041.0,-2258229.0 -17258230.0,-2248575.0 -17250496.0,-2245708.0 -17246610.0,-2234405.0 -17227426.0,-2214708.0 -17247804.0,-2191802.0 -17274071.0,-2179839.0 -17284400.0,-2180795.0 -17306407.0,-2166165.0 -17317483.0,-2147228.0 -17331805.0,-2139258.0 -17360727.0,-2161250.0 -17359519.0,-2195505.0 -17379121.0,-2241840.0 ",ball: {x:17,y:26,d:5,a:1,s:20,el:null},hole: {x:16,y:8},cd: 1502});
	golfHoles.push({path:"M-9701178.0,-5369970.0 -9695161.0,-5437646.0 -9621457.0,-5437537.0 -9624132.0,-5469058.0 -9577941.0,-5463844.0 -9578319.0,-5491336.0 -9525003.0,-5490990.0 -9524778.0,-5356871.0 -9550149.0,-5356677.0 -9549932.0,-5316673.0 -9535686.0,-5316394.0 -9545840.0,-5307715.0 -9534027.0,-5294303.0 -9523464.0,-5303000.0 -9522918.0,-5289850.0 -9549220.0,-5290124.0 -9549264.0,-5276756.0 -9587581.0,-5276786.0 -9580969.0,-5275497.0 -9581102.0,-5270865.0 -9588732.0,-5276777.0 -9691332.0,-5276301.0 -9701178.0,-5369970.0 ",ball: {x:74,y:58,d:5,a:1,s:20,el:null},hole: {x:44,y:85},cd: 2602});
	golfHoles.push({path:"M-7940704.0,-5245349.0 -7934314.0,-5259790.0 -7917494.0,-5253520.0 -7918652.0,-5269626.0 -7910239.0,-5271338.0 -7903545.0,-5282636.0 -7908684.0,-5288966.0 -7894181.0,-5294734.0 -7874185.0,-5292917.0 -7871883.0,-5271255.0 -7853513.0,-5270081.0 -7848263.0,-5256650.0 -7859856.0,-5240889.0 -7864507.0,-5221936.0 -7895290.0,-5219097.0 -7898206.0,-5227767.0 -7904884.0,-5226300.0 -7918763.0,-5240705.0 -7935058.0,-5230082.0 -7940704.0,-5245349.0 ",ball: {x:26,y:59,d:5,a:1,s:20,el:null},hole: {x:72,y:30},cd: 2506});
	golfHoles.push({path:"M-18727449.0,-9775292.0 -18126379.0,-10135239.0 -18587250.0,-10543491.0 -18517711.0,-10719913.0 -18258664.0,-10761092.0 -18085546.0,-11139794.0 -17430657.0,-11550113.0 -16844306.0,-11221253.0 -15696358.0,-10972939.0 -15696269.0,-8468266.0 -15481738.0,-8478641.0 -15309371.0,-8160277.0 -15054143.0,-8332396.0 -14675841.0,-7678637.0 -14483089.0,-7582900.0 -14468658.0,-7416774.0 -14543659.0,-7294022.0 -14877728.0,-7290779.0 -14898776.0,-7517376.0 -14983860.0,-7523163.0 -15196828.0,-8005348.0 -15390199.0,-8178105.0 -15840460.0,-8402372.0 -16105344.0,-8339294.0 -16250037.0,-8470127.0 -17034240.0,-8180917.0 -17384453.0,-7831139.0 -17588480.0,-7486971.0 -17815701.0,-7449476.0 -17725024.0,-7327141.0 -17839851.0,-7324477.0 -17833781.0,-7427308.0 -17912186.0,-7443883.0 -18074393.0,-7266900.0 -18105336.0,-7348936.0 -18346051.0,-7235870.0 -18314414.0,-7355876.0 -17687953.0,-7748897.0 -17596252.0,-8071031.0 -18059393.0,-8094120.0 -18017193.0,-8139000.0 -18053609.0,-8358629.0 -18257877.0,-8319527.0 -18510289.0,-8756230.0 -18354382.0,-9116316.0 -17954185.0,-9229749.0 -17930832.0,-9402436.0 -18509310.0,-9461815.0 -18584670.0,-9689947.0 -18727449.0,-9775292.0 ",ball: {x:22,y:33,d:5,a:1,s:20,el:null},hole: {x:13,y:68},cd: 0200});
	golfHoles.push({path:"M-9804010.0,-5330491.0 -9803168.0,-5341260.0 -9791579.0,-5341304.0 -9791801.0,-5337954.0 -9787317.0,-5333386.0 -9787729.0,-5341264.0 -9698044.0,-5341061.0 -9692523.0,-5287976.0 -9776792.0,-5287988.0 -9782912.0,-5301328.0 -9792116.0,-5302485.0 -9790913.0,-5309034.0 -9800310.0,-5307959.0 -9793627.0,-5311862.0 -9794163.0,-5315645.0 -9801366.0,-5316690.0 -9794444.0,-5317629.0 -9794724.0,-5321776.0 -9800391.0,-5322265.0 -9799179.0,-5327883.0 -9804010.0,-5330491.0 ",ball: {x:86,y:51,d:5,a:1,s:20,el:null},hole: {x:17,y:6},cd: 5504});
	golfHoles.push({path:"M-8824122.0,-4288372.0 -8822955.0,-4334171.0 -8788740.0,-4333602.0 -8795297.0,-4287200.0 -8776459.0,-4292769.0 -8749759.0,-4281546.0 -8749785.0,-4287979.0 -8736305.0,-4287906.0 -8732335.0,-4281176.0 -8734337.0,-4269884.0 -8741096.0,-4269002.0 -8741274.0,-4261077.0 -8749895.0,-4259721.0 -8750790.0,-4254057.0 -8755391.0,-4263707.0 -8770090.0,-4267362.0 -8775717.0,-4257131.0 -8778050.0,-4268554.0 -8787145.0,-4269280.0 -8783784.0,-4282487.0 -8822018.0,-4283684.0 -8824122.0,-4288372.0 ",ball: {x:28,y:28,d:5,a:1,s:20,el:null},hole: {x:69,y:63},cd: 3704});
	golfHoles.push({path:"M-8402847.0,-4926938.0 -8370870.0,-4954778.0 -8369546.0,-4948874.0 -8356596.0,-4945047.0 -8355482.0,-4926900.0 -8345238.0,-4923971.0 -8342250.0,-4915183.0 -8318020.0,-4887809.0 -8346065.0,-4873006.0 -8345037.0,-4883188.0 -8365854.0,-4897878.0 -8370720.0,-4893330.0 -8380090.0,-4898402.0 -8386364.0,-4905703.0 -8386737.0,-4914260.0 -8402847.0,-4926938.0 ",ball: {x:52,y:20,d:5,a:1,s:20,el:null},hole: {x:72,y:65},cd: 4201});
	golfHoles.push({path:"M-12486649.0,-3985143.0 -12480841.0,-3990318.0 -12480364.0,-4001638.0 -12470184.0,-4001862.0 -12471209.0,-4015533.0 -12457579.0,-4009648.0 -12449870.0,-4015452.0 -12449869.0,-4003839.0 -12442146.0,-4003835.0 -12442146.0,-3996070.0 -12425391.0,-3991063.0 -12432610.0,-3962506.0 -12453820.0,-3953429.0 -12473109.0,-3972845.0 -12484656.0,-3966995.0 -12486649.0,-3985143.0 ",ball: {x:55,y:17,d:5,a:1,s:20,el:null},hole: {x:82,y:55},cd: 0406});
	golfHoles.push({path:"M-10841274.0,-3844165.0 -10826126.0,-3846439.0 -10821060.0,-3859220.0 -10830210.0,-3862126.0 -10802715.0,-3868763.0 -10803086.0,-3860552.0 -10805053.0,-3863428.0 -10811690.0,-3863157.0 -10802045.0,-3854650.0 -10802264.0,-3835548.0 -10743563.0,-3833818.0 -10736929.0,-3808759.0 -10702982.0,-3791134.0 -10706246.0,-3785415.0 -10698296.0,-3783366.0 -10692331.0,-3765463.0 -10741965.0,-3736587.0 -10766723.0,-3739036.0 -10807585.0,-3798206.0 -10807657.0,-3835650.0 -10841001.0,-3836195.0 -10841274.0,-3844165.0 ",ball: {x:65,y:32,d:5,a:1,s:20,el:null},hole: {x:95,y:64},cd: 4806});
	golfHoles.push({path:"M-10935526.0,-3256284.0 -10896302.0,-3256149.0 -10888023.0,-3272118.0 -10919303.0,-3332820.0 -10861959.0,-3351905.0 -10882049.0,-3376551.0 -10866244.0,-3389624.0 -10893522.0,-3420748.0 -10872017.0,-3453225.0 -10842973.0,-3419693.0 -10824719.0,-3424674.0 -10795361.0,-3388895.0 -10832045.0,-3358352.0 -10815122.0,-3320768.0 -10861274.0,-3265354.0 -10852423.0,-3248824.0 -10883417.0,-3256007.0 -10901994.0,-3234508.0 -10891574.0,-3193406.0 -10816369.0,-3194655.0 -10833971.0,-3124753.0 -10808134.0,-2995841.0 -10839534.0,-2979272.0 -10871765.0,-3003798.0 -10931930.0,-3007022.0 -10926151.0,-3029375.0 -10893934.0,-3013988.0 -10893939.0,-3052881.0 -10909776.0,-3054772.0 -10907760.0,-3156055.0 -10935188.0,-3156304.0 -10935526.0,-3256284.0 ",ball: {x:18,y:15,d:5,a:1,s:20,el:null},hole: {x:15,y:28},cd: 4834});
	golfHoles.push({path:"M-10914825.0,-3584117.0 -10905176.0,-3604942.0 -10890220.0,-3620572.0 -10899720.0,-3641308.0 -10892215.0,-3645822.0 -10888067.0,-3644216.0 -10888653.0,-3640413.0 -10883205.0,-3640204.0 -10884578.0,-3648417.0 -10888811.0,-3647850.0 -10844590.0,-3674404.0 -10836221.0,-3664506.0 -10828913.0,-3669103.0 -10805804.0,-3630960.0 -10826831.0,-3618419.0 -10833113.0,-3600631.0 -10828205.0,-3598471.0 -10815270.0,-3562474.0 -10835223.0,-3555437.0 -10864363.0,-3568179.0 -10884351.0,-3558917.0 -10892432.0,-3564452.0 -10894601.0,-3573992.0 -10901182.0,-3576727.0 -10900078.0,-3581540.0 -10914825.0,-3584117.0 ",ball: {x:62,y:88,d:5,a:1,s:20,el:null},hole: {x:73,y:41},cd: 4831});
	golfHoles.push({path:"M-10791879.0,-4009051.0 -10789482.0,-4023349.0 -10771451.0,-4005248.0 -10760130.0,-4017618.0 -10725283.0,-3986746.0 -10686997.0,-4011841.0 -10607515.0,-4011771.0 -10599473.0,-4023788.0 -10507087.0,-3967870.0 -10472152.0,-3973186.0 -10468835.0,-3854629.0 -10542194.0,-3867872.0 -10542155.0,-3849231.0 -10573998.0,-3834067.0 -10566507.0,-3862032.0 -10592355.0,-3850387.0 -10592045.0,-3896100.0 -10592295.0,-3897089.0 -10649422.0,-3890053.0 -10648759.0,-3857065.0 -10679372.0,-3873717.0 -10744443.0,-3870591.0 -10726718.0,-3918552.0 -10731293.0,-3942795.0 -10779934.0,-3930243.0 -10779524.0,-3949252.0 -10791741.0,-3950707.0 -10791879.0,-4009051.0 ",ball: {x:22,y:20,d:5,a:1,s:20,el:null},hole: {x:88,y:27},cd: 4804});
	golfHoles.push({path:"M-8263723.0,-5033458.0 -8235570.0,-5060352.0 -8213153.0,-5062991.0 -8210967.0,-5047275.0 -8211999.0,-5042714.0 -8205753.0,-5044823.0 -8206562.0,-5041413.0 -8203544.0,-5037255.0 -8203766.0,-5029606.0 -8207338.0,-5027206.0 -8199265.0,-5014148.0 -8199528.0,-5010203.0 -8202570.0,-5012001.0 -8205996.0,-5006337.0 -8209053.0,-5007775.0 -8213600.0,-5015381.0 -8216986.0,-5012605.0 -8220282.0,-5015885.0 -8221908.0,-5012045.0 -8226813.0,-5011947.0 -8263723.0,-5033458.0 ",ball: {x:92,y:40,d:5,a:1,s:20,el:null},hole: {x:81,y:11},cd: 3617});
	golfHoles.push({path:"M-8879112.0,-5238601.0 -8828987.0,-5264421.0 -8793719.0,-5240976.0 -8785308.0,-5227479.0 -8734566.0,-5241661.0 -8665186.0,-5238857.0 -8665135.0,-5232336.0 -8652081.0,-5231829.0 -8645062.0,-5248322.0 -8622322.0,-5247791.0 -8613194.0,-5258152.0 -8598902.0,-5289914.0 -8599053.0,-5318026.0 -8539742.0,-5315631.0 -8542599.0,-5277045.0 -8534481.0,-5254833.0 -8489846.0,-5254852.0 -8488485.0,-5222228.0 -8474773.0,-5222646.0 -8469308.0,-5193788.0 -8473786.0,-5170739.0 -8487381.0,-5176441.0 -8512939.0,-5160851.0 -8878989.0,-5160801.0 -8879112.0,-5238601.0 ",ball: {x:92,y:60,d:5,a:1,s:20,el:null},hole: {x:31,y:57},cd: 3623});
	golfHoles.push({path:"M-8210432.0,-4951041.0 -8207756.0,-4956206.0 -8208859.0,-4960397.0 -8203683.0,-4962894.0 -8202669.0,-4965759.0 -8202987.0,-4969417.0 -8207622.0,-4971446.0 -8205098.0,-4972274.0 -8204348.0,-4975952.0 -8195482.0,-4976507.0 -8189644.0,-4979552.0 -8187604.0,-4977741.0 -8184893.0,-4966990.0 -8181407.0,-4966856.0 -8182741.0,-4963033.0 -8182109.0,-4960107.0 -8180273.0,-4960674.0 -8180307.0,-4941932.0 -8204925.0,-4943927.0 -8204931.0,-4950508.0 -8210432.0,-4951041.0 ",ball: {x:20,y:53,d:5,a:1,s:20,el:null},hole: {x:23,y:13},cd: 3604});
	

}
addHoles();
app.get('/golf', 
	function(req, res) {
		//var path = "M 188.05 123.86 187.66 123.67 187.54 123.5 187.54 123.27 187.47 123.02 187.24 122.59 187.08 122.47 186.97 122.18 186.86 121.68 186.69 121.36 186.46 121.22 186.3 121.06 186.22 120.87 186.14 120.75 186.05 120.69 186.01 120.59 186.0 120.45 185.87 120.27 185.48 119.93 185.38 119.73 185.2 119.51 184.74 119.08 184.74 119.08 184.3 118.24 184.3 118.24 184.25 118.07 184.15 118.0 184.0 117.98 183.85 117.89 183.63 117.68 183.63 117.68 183.27 117.42 183.34 117.19 183.62 116.88 183.72 116.72 183.73 116.71 183.77 116.71 184.07 116.61 184.38 116.51 184.45 116.52 184.62 116.41 184.98 116.29 185.12 116.21 185.19 116.23 185.5 116.25 185.8 116.26 186.11 116.27 186.41 116.29 186.72 116.3 187.02 116.32 187.33 116.33 187.63 116.34 187.69 116.37 187.71 116.4 187.7 116.5 187.71 116.56 187.93 116.44 188.03 116.58 188.2 116.81 188.21 116.94 188.22 117.13 188.49 117.14 188.76 117.15 189.03 117.16 189.3 117.17 189.58 117.18 189.85 117.19 190.12 117.2 190.39 117.21 190.65 117.48 190.91 117.76 191.17 118.03 191.43 118.31 191.69 118.58 191.95 118.85 192.21 119.13 192.49 119.42 192.46 119.43 191.95 119.79 191.8 119.94 191.38 120.55 191.28 120.94 191.19 120.78 191.21 120.65 191.21 120.55 191.11 120.77 191.21 121.08 191.12 121.2 190.84 121.43 190.69 121.46 190.52 121.53 190.47 121.75 190.23 121.95 190.1 122.04 189.85 121.99 189.93 122.18 189.84 122.33 189.68 122.44 189.49 122.52 189.38 122.51 189.28 122.55 189.21 122.64 189.03 122.73 188.84 122.68 188.62 122.65 188.5 122.7 188.7 122.79 188.81 122.92 188.79 123.09 188.74 123.15 188.61 123.24 188.55 123.23 188.52 123.15 188.48 122.98 188.42 123.02 188.41 123.09 188.36 123.12 188.18 122.86 188.19 123.06 188.25 123.22 188.31 123.3 188.37 123.34 188.39 123.41 188.27 123.59 188.2 123.63 188.09 123.66 188.03 123.77 188.05 123.86 Z";
		var shape = "FL";
		
		//var path = jsonShapes[shape];
		//console.log(path);
		
		
		var allHoles = [];
		for (var i=0;i<golfHoles.length;i++){
			var retval = pathToPoints(golfHoles[i].path);
			var ball = pathToPoints(golfHoles[i].ball);
			var hole = pathToPoints(golfHoles[i].hole);
			var cd = pathToPoints(golfHoles[i].cd);
			allHoles.push({bigwall:retval[0],width:retval[1],ball:ball,hole:hole,cd:cd});
		}
		var retval = pathToPoints(path);
		res.write(nunjucks.render('templates/golf.html',{
			//bigwall: {id:"wall-0",balls:[],v:[[0,0],[0,50],[0,100],[100,100],[190,20],[9,2],[0,0]]},
			//bigwall: retval[0],
			//width: retval[1],
			//ball: ball,
			//hole: hole,
			allHoles: allHoles,
		}));
		res.end();
	}
);
function replaceNegatives(istr){
	dindex = istr.indexOf('-')
	while (dindex >-1){
		if (dindex == 0){
			if ("0123456789".indexOf(istr[1]) == -1) {
				istr = '-1*'+istr.substring(1,);
			}
			dindex = istr.indexOf('-',1);
		}
		else{
			if ("><=![]&|(".indexOf(istr[dindex-1])> -1) {
				if ("0123456789".indexOf(istr[dindex-1])== -1){
					istr = istr.substring(0,dindex)+'-1*'+istr.substring(dindex+1,);
				}
				dindex = istr.indexOf('-',dindex+1);
			}
			else{
				istr = istr.substring(0,dindex)+'~'+istr.substring(dindex+1,);
				dindex = istr.indexOf('-',dindex+1);
			}
		}
	}
				
	return istr
}
function closePar(str,i){
	var openPar = 0;
	for (var ii=i;ii<str.length;ii++){
		if (str[ii]== "("){
			openPar++;
		}
		else if (str[ii]== ")"){
			openPar--;
		}
		
		if (openPar == 0){
			return ii;
		}
	}
	return str.length;
}
function findComma(str,i,ii,rep){
	var openPar = 0;
	inside = "";
	var foundComma = false;
	for (var iii=i;iii<ii;iii++){
		if (str[iii]== "("){
			openPar++;
		}
		else if (str[iii]== ")"){
			openPar--;
		}
		
		if (openPar == 0 && str[iii]==","){
			inside = "("+inside+")"+rep+"(";
			foundComma = true;
		}
		else {
			inside += str[iii];
		}
	}
	if (!foundComma){
		return false;
	}
	return inside+")";
}
function replaceFunctions(str){
	for (var i=0;i<str.length-1;i++){
		if (str[i+1]=="("){
			if (str[i] == "X" || str[i] == "N"){
				var ii = closePar(str,i+1);
				console.log(str,i,ii);
				var inside = findComma(str,i+2,ii+1,str[i]);
				if (!inside){
					continue;
				}
				if (ii+1 < str.length){
					str = str.substr(0,i)+"("+inside+str.substr(ii+1);
				}
				else {
					str = str.substr(0,i)+"("+inside;
				}
				console.log(str);
			}
			else if (str[i] == "A" || str[i] == "L" || str[i] == "R" || str[i] == "F" ){
				var ii = closePar(str,i+1);
				console.log(str,i,ii);
				if (ii+1 < str.length){
					str = str.substr(0,i)+str.substr(i+1,ii-i)+str[i]+str.substr(ii+1);
				}
				else {
					str = str.substr(0,i)+str.substr(i+1,ii-i)+str[i];
				}
				console.log(str);
			}
		}
	}
	return str;
}
function makePostfix(infixexpr) {
	infixexpr = infixexpr.replace(/ /g,"");
	infixexpr = infixexpr.replace(/max/gi,"X");
	infixexpr = infixexpr.replace(/min/gi,"N");
	infixexpr = infixexpr.replace(/abs/gi,"A");
	infixexpr = infixexpr.replace(/log/gi,"L");
	infixexpr = infixexpr.replace(/ln/gi,"L");
	infixexpr = infixexpr.replace(/round/gi,"R");
	infixexpr = infixexpr.replace(/floor/gi,"F");
	infixexpr = infixexpr.replace(/rand/gi,"?");
	infixexpr = replaceNegatives(infixexpr);
	infixexpr = replaceFunctions(infixexpr);
	console.log(infixexpr);
	prec = {}
	prec["X"] = 5
	prec["N"] = 5
	prec["A"] = 5
	prec["L"] = 5
	prec["R"] = 5
	prec["F"] = 5
	prec["*"] = 4
	prec["/"] = 4
	prec["+"] = 3
	prec["~"] = 3
	/*prec[">"] = 2
	prec["<"] = 2
	prec["="] = 2
	prec["!"] = 2
	prec["["] = 2
	prec["]"] = 2
	prec["&"] = 1
	prec["|"] = 0*/
	prec["("] = -1
	opStack = []
	postfixList = []
	intstr = []
	expstr = []
	tokenList = []
	temptoken = ''
	for (var i=0;i<infixexpr.length;i++){
		var ie = infixexpr[i];
		if ("-0123456789.?abcdefghijklmnopqrstuvwxyz".indexOf(ie) > -1){
			temptoken += ie
		}
		else{
			if (temptoken != ''){
				tokenList.push(temptoken)
			}
			tokenList.push(ie)
			temptoken = ''
		}
	}
	if (temptoken != ''){
		tokenList.push(temptoken)
	}
	
	for (var i=0;i<tokenList.length;i++){
		var token = tokenList[i];
		if ("*/+~><=![]&|()AFLNRX".indexOf(token) == -1){
			postfixList.push(token)
		}
		else if (token == '('){
			opStack.push(token)
		}
		else if (token == ')'){
			topToken = opStack.pop()
			while (topToken != '('){
				postfixList.push(topToken)
				topToken = opStack.pop()
			}
		}
		else {
			while ((opStack.length > 0) && (prec[opStack[opStack.length-1]] >= prec[token])){
				postfixList.push(opStack.pop())
			}
			opStack.push(token)
		}
	}
	while (opStack.length > 0){
		postfixList.push(opStack.pop())
	}
	for (var i=0;i<postfixList.length;i++){
		var ci = postfixList[i];
		if ("*/+~><=![]&|AFLNRX".indexOf(ci) == -1){
			intstr.push(ci);
			expstr.push('_');
		}
		else if (ci == '~'){
			expstr.push('-');
		}
		else{
			expstr.push(ci);
		}
	}
	var sout = "";
	for (var i=0;i<expstr.length;i++){
		sout += expstr[i];
	}
	sout += "~";
	for (var i=0;i<intstr.length;i++){
		sout += intstr[i];
		sout += "_";
	}
	//sout = sout.substr(0,sout.length-1);
	console.log(sout.substr(0,sout.length-1));
	return encodeURIComponent(sout.substr(0,sout.length-1));

}


app.post('/makegame.html', 
	function(req, res) {
		//var content = req.body;
		console.log(req.body);
		var lives = makePostfix(req.body.lives);
		var pointFormula = makePostfix(req.body.pointFormula);
		var balls = makePostfix(req.body.balls);
		var win = makePostfix(req.body.win);
		var speed = makePostfix(req.body.speed);
		console.log(lives);
		console.log(pointFormula);
		console.log(balls);
		console.log(win);
		console.log(speed);
		res.redirect("../game?n=SC&l="+lives+"&f="+pointFormula+"&b="+balls+"&w="+win+"&s="+speed);
	}
);

app.get('/landing.html', 
	function(req, res) {
		res.write(nunjucks.render('templates/landing.html',{
		
		}));
		res.end();
	}
);

app.post('/save.html', 
	function(req, res) {
		var content = req.body.svg;
		fs.writeFile('saved/'+req.body.name+'.svg', content, err => {
		  if (err) {
			console.error(err)
			return
		  }
		  //file written successfully
		});
		var curves = req.body.curves;
		fs.writeFile('saved/'+req.body.name+'.txt', curves, err => {
		  if (err) {
			console.error(err)
			return
		  }
		  //file written successfully
		});
		res.redirect('/text.html');
	}
);

app.get('/home.html', 
	function(req, res) {
		res.write(nunjucks.render('templates/index.html',{
		
		}));
		res.end();
	}
);

app.get('/memes.html', 
	function(req, res) {
		res.write(nunjucks.render('templates/memes.html',{
		
		}));
		res.end();
	}
);
app.get('/scrims.html', 
	function(req, res) {
		res.write(nunjucks.render('templates/scrims.html',{
		
		}));
		res.end();
	}
);
app.get('/images.html', 
	function(req, res) {
		res.write(nunjucks.render('templates/images.html',{
		
		}));
		res.end();
	}
);
app.get('/text.html', 
	function(req, res) {
		res.write(nunjucks.render('templates/text.html',{
		
		}));
		res.end();
	}
);
app.get('/code.html', 
	function(req, res) {
		res.write(nunjucks.render('templates/code.html',{
		
		}));
		res.end();
	}
);
app.get('/writing.html', 
	function(req, res) {
		res.write(nunjucks.render('templates/writing.html',{
		
		}));
		res.end();
	}
);
app.get('/tooltips.html', 
	function(req, res) {
		res.write(nunjucks.render('templates/tooltips.html',{
		
		}));
		res.end();
	}
);

const server1 = https.createServer(options, app);
server1.listen(12312);









