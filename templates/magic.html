<!doctype html>
<html>
<head>
<title>MagicEye.js Text Example</title>
<style>
#magiceye {
	position: absolute;
	left: 0px;
	top: 0px;
	display: inline-block;
}
#magicbg {
	position: absolute;
	left: 0px;
	top: 0px;
	display: inline-block;
	width: 800px;
	height: 600px;
	background: red;
}	
.input {
	position: absolute;
	left: 0px;
	top: 0px;
	display: inline-block;
	width: 800px;
	height: 600px;
	opacity: 0;
}

</style>

</head>
<body>
<script src="js/mymagic.js" type="text/javascript"></script>
<script src="js/TextDepthMapper.js" type="text/javascript"></script>

<div id="magicbg">
	
</div>
<canvas id="magiceye" width="800" height="600" >
</canvas>
<div class="input">

</div>
<button style="position:absolute; left:800px; top:0px;" onclick="reRender()">Again</button>

<script src='js/perlin.js'></script>
<script>
	noise.seed(Math.random());
  var colorChain = {};
  for (var i=0;i<1200;i++){
  	colorChain[i]={};
  }
  var dMap = [];
  for (var y=0;y<600;y++){
  	  dMap.push([]);
	  for (var x=0;x<800;x++){
	  	  var v = Math.abs(noise.perlin2(x/800,y/600));
	  	  v *= 2;
	  	  if (v > 1){v = 1;}
  		  dMap[y].push(v);
	  }
  }
  
  var dMap = [];
  var pMap = [];
  for (var y=0;y<600;y++){
  	  dMap.push([]);
  	  pMap.push([]);
	  for (var x=0;x<800;x++){
	  	  
  		  dMap[y].push(0);
  		  pMap[y].push(0);
	  }
  }
  for (var i=9;i<10;i++){
	  for (var y=60+i*5;y<60+i*5+300;y++){
		  for (var x=210+i*5;x<210+i*5+100;x++){
		  
			  dMap[y][x] = (i+1)/10;
		  }
	  }
  }
  
  var c=75;
  MagicEye.render({
    el: 'magiceye',
    s: 72,
    depthMap: dMap
  });


  
  function reRender() {
	
	  c++;
	  var dMap = [];
	  for (var y=0;y<600;y++){
		  dMap.push([]);
		  for (var x=0;x<800;x++){
		  
			  dMap[y].push(0);
		  }
	  }
	  for (var i=9;i<10;i++){
		  for (var y=60+i*5;y<60+i*5+c*4;y++){
			  for (var x=210+i*5;x<210+i*5+100;x++){
		  
				  dMap[y][x] = (i+1)/10;
			  }
		  }
	  }
  	MagicEye.render({
		el: 'magiceye',
		s: 72,
		depthMap: dMap,
	  });
  }


var curveWorker = new Worker('js/curveWorker.js');
var inputEl = document.querySelector('.input');
inputEl.addEventListener('pointerdown',inputDown);
inputEl.addEventListener('pointermove',inputMove);
inputEl.addEventListener('pointercancel',inputCancel);
inputEl.addEventListener('pointerup',inputUp);
var isDown = false;

curveWorker.onmessage = function(evt){
	if (evt.data.type == 'inputCurve'){
		/*for (var i=0;i<evt.data.points.length;i++){
			drawCurveIn(evt.data.points[i]);
		}*/
	}
	else if (evt.data.type == 'outputCurve'){
		//drawCurveOut(evt.data.id,evt.data.pd,evt.data.startPoint,evt.data.endPoint);
		console.log(evt.data.pd);
	}
	else if (evt.data.type == 'convexHull'){
		//drawConvexHull(evt.data.pdArray);
	}
}

function inputCancel(evt){
	if (evt.pointerType == 'pen' || evt.pointerType == 'mouse'){
		evt.preventDefault();
	}
	isDown = false;
	curveWorker.postMessage({'type':'up','x':evt.clientX,'y':evt.clientY});
}
function inputDown(evt) {
	evt.preventDefault();
	if (evt.pointerType == 'pen' || evt.pointerType == 'mouse'){
		curveWorker.postMessage({'type':'down','x':evt.clientX,'y':evt.clientY});
		isDown = true;
	}
	else {
		//document.getElementById('pointerType').innerHTML = evt.pointerType;
	}
}
function inputMove(evt) {
	evt.preventDefault();
	if (isDown && (evt.pointerType == 'pen' || evt.pointerType == 'mouse')){
		curveWorker.postMessage({'type':'move','x':evt.clientX,'y':evt.clientY});
	}
	else {
	}
}
function inputUp(evt) {
	evt.preventDefault();
	if (isDown && (evt.pointerType == 'pen' || evt.pointerType == 'mouse')){
		isDown = false;
		
		curveWorker.postMessage({'type':'up','x':evt.clientX,'y':evt.clientY});
	}
	else {
	}
}

</script>
</body>
</html>
