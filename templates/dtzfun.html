<!doctype html>
<html>
<head>
<title>DTZFun</title>
<style>
.game {
	margin: auto;
	width: 60vw;
	height: 60vh;
	left: 20vw;
	top: 20vh;
	position: absolute;
	border: 1px solid black;
}
#borderSVG {
	width: 90%;
	height: 90%;
	left: 5%;
	top: 5%;
	position: absolute;
}

</style>

</head>
<body>

<div class="game">
	<svg id="borderSVG" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
		
		<circle id="ball-0" cx="50" cy="50" r="3" fill="#CCF" stroke="black" stroke-width="0" />
		<circle id="ball-1" cx="50" cy="20" r="3" fill="#CCF" stroke="black" stroke-width="0" />
		<!--<path d="M0,0 0,100 100,100 80,20 0,0" fill="none" stroke="red" stroke-width="1" />-->
	</svg>
</div>

<script>
walls = [{id:"wall-0",v:[[0,0],[0,100],[100,100],[80,20],[0,0]]}];
nWalls = 1;
makeEdges();
addWall(walls[0]);
r = 3;
balls = [{id:"ball-0",x:50,y:50,a:-1,el:document.getElementById("ball-0")}];
balls.push({id:"ball-1",x:50,y:20,a:2,el:document.getElementById("ball-1")});
nBalls = 2;
let start;
let old;

function addWall(wall) {
	var svg = document.getElementById("borderSVG");
	var path = document.createElementNS("http://www.w3.org/2000/svg", "path");
	var pd = "M";
	for (var ii=1;ii<wall.v.length;ii++){
		pd += wall.v[ii][0]+","+wall.v[ii][1]+" ";
	}
	path.setAttributeNS(null,'d',pd);
	path.setAttributeNS(null,'fill',"none");
	path.setAttributeNS(null,'stroke',"red");
	path.setAttributeNS(null,'stroke-width',"1");
	svg.appendChild(path);
}
function makeEdges(){
	for (var i=0;i<nWalls;i++){
		walls[i].e = [];
		for (var ii=1;ii<walls[i].v.length;ii++){
			var edge = [];
			if (walls[i].v[ii][0]-walls[i].v[ii-1][0] == 0){
				edge.push("inf");
			}
			else {
				edge.push((walls[i].v[ii][1]-walls[i].v[ii-1][1])/(walls[i].v[ii][0]-walls[i].v[ii-1][0]));
			}
			if (walls[i].v[ii][1]-walls[i].v[ii-1][1] == 0){
				edge.push("inf");
			}
			else {
				edge.push(-1*(walls[i].v[ii][0]-walls[i].v[ii-1][0])/(walls[i].v[ii][1]-walls[i].v[ii-1][1]));
			}
			edge.push(walls[i].v[ii-1]);
			edge.push(walls[i].v[ii]);
			walls[i].e.push(edge);
		}
	}
}

function collision(pt){
	var minD = r+1;
	var c = {wall:0,edge:0,d:minD};
	for (var i=0;i<nWalls;i++){
		for (var ii=0;ii<walls[i].e.length;ii++){
			var d = r+1;
			if (pt.x < Math.min(walls[i].e[ii][2][0]-r,walls[i].e[ii][3][0]-r)) {
				//no collision
			}
			else if (pt.x > Math.max(walls[i].e[ii][2][0]+r,walls[i].e[ii][3][0]+r)) {
				//no collision
			}
			else if (pt.y < Math.min(walls[i].e[ii][2][1]-r,walls[i].e[ii][3][1]-r)) {
				//no collision
			}
			else if (pt.y > Math.max(walls[i].e[ii][2][1]+r,walls[i].e[ii][3][1]+r)) {
				//no collision
			}
			else {
				var pm = walls[i].e[ii][1];//perpendicular slope of edge
				
				if (pm == "inf"){
					d = Math.pow(walls[i].e[ii][2][1]-pt.y,2);
				}
				else if (walls[i].e[ii][0] == "inf"){
					d = Math.pow(walls[i].e[ii][2][0]-pt.x,2);
				}
				else {
					var xc = (walls[i].e[ii][2][1]-pt.y+pt.x*pm-walls[i].e[ii][2][0]*walls[i].e[ii][0])/(pm-walls[i].e[ii][0]);
					var yc = pm*(xc-pt.x)+pt.y;
					d = Math.pow(pt.x-xc,2)+ Math.pow(pt.y-yc,2);
				}
			}
			//console.log(pt,d);
			if (d<minD){
				minD=d;
				c.wall = i;
				c.edge = ii;
				c.d = d;
			}
		}
	}

	return c;
}

function move(timestamp) {
	if (start === undefined){
		start = timestamp;
		old = timestamp;
		window.requestAnimationFrame(move);
		return;
	}
	const elapsed = timestamp - old;
	old = timestamp;
	for (var i=0;i<nBalls;i++){
		var x = balls[i].x+Math.cos(balls[i].a)*elapsed/40;
		var y = balls[i].y+Math.sin(balls[i].a)*elapsed/40;
		
		var c = collision({x:x,y:y});
		if (c.d < r){
			console.log(c);
			var m = walls[c.wall].e[c.edge][0];
			var b = Math.atan(m);
			if (m == "inf"){
				b = Math.PI/2;
			}
			console.log(m);
			console.log(b);
			balls[i].a = -1*(2*Math.PI+balls[i].a-2*b);
			console.log(balls[i].a);
		}
		balls[i].el.setAttribute("cx",x);
		balls[i].el.setAttribute("cy",y);
		
		balls[i].x = x;
		balls[i].y = y;
	}
	
	
	
	if (timestamp - start < 10000) {
		window.requestAnimationFrame(move);
	}
}

window.requestAnimationFrame(move);
</script>
</body>
</html>